<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Studio - Generator Foto Produk UGC</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .step-badge {
            background-color: #e0e7ff; color: #4338ca; 
            font-weight: 700; padding: 0.25rem 0.75rem; 
            border-radius: 9999px; font-size: 0.75rem;
        }
        .preview-box {
            background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M0 0h10v10H0zM10 10h10v10H10z" fill="%23f0f0f0" fill-opacity="0.4"/%3E');
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 pb-20">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="camera" class="text-indigo-600"></i>
                <h1 class="font-bold text-xl tracking-tight text-gray-900">AI Studio UGC</h1>
            </div>
            <div class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                Versi Beta 1.0
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-3xl mx-auto px-4 py-8 space-y-6">

        <!-- API Key Config (Hidden in production, visible for demo) -->
        <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4">
            <label class="block text-xs font-bold text-indigo-800 uppercase mb-2">Konfigurasi API Key (Gemini)</label>
            <div class="flex gap-2">
                <input type="password" id="apiKeyInput" placeholder="Masukkan API Key Google Gemini Anda di sini..." 
                    class="w-full px-4 py-2 rounded-lg border border-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
            </div>
            <p class="text-xs text-indigo-600 mt-2">*API Key diperlukan agar aplikasi dapat berjalan.</p>
        </div>

        <!-- STEP 1: Upload Produk -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative overflow-hidden">
            <div class="flex items-center gap-3 mb-4">
                <span class="step-badge">Langkah 1</span>
                <h2 class="font-bold text-lg">Upload Foto Produk</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Upload Area -->
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition-colors cursor-pointer relative" id="dropZoneProduct">
                    <input type="file" id="productInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="flex flex-col items-center justify-center h-full space-y-3">
                        <div class="bg-indigo-100 p-3 rounded-full">
                            <i data-lucide="upload-cloud" class="text-indigo-600 w-6 h-6"></i>
                        </div>
                        <div class="text-sm">
                            <span class="font-semibold text-indigo-600">Klik untuk upload</span> atau drag & drop
                        </div>
                        <p class="text-xs text-gray-400">PNG, JPG (Max 5MB)</p>
                    </div>
                </div>

                <!-- Preview Area -->
                <div class="preview-box bg-gray-100 rounded-xl h-48 md:h-auto flex items-center justify-center overflow-hidden relative border border-gray-200">
                    <img id="productPreview" class="hidden w-full h-full object-contain" alt="Preview Produk">
                    <span id="productPlaceholder" class="text-gray-400 text-sm">Belum ada foto</span>
                </div>
            </div>
        </section>

        <!-- STEP 2: Deskripsi Otomatis -->
        <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center gap-3 mb-4">
                <span class="step-badge">Langkah 2</span>
                <h2 class="font-bold text-lg">Deskripsi AI</h2>
            </div>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Biarkan AI menganalisis produk Anda untuk hasil yang lebih akurat.</p>
                
                <button id="btnAutoDescribe" class="flex items-center gap-2 bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    <span>Buat Deskripsi Otomatis</span>
                </button>

                <div class="relative">
                    <textarea id="productDescription" rows="4" 
                        class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm leading-relaxed"
                        placeholder="Deskripsi produk akan muncul di sini (atau ketik manual)..."></textarea>
                    <div id="descLoader" class="absolute right-4 bottom-4 hidden">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Container Grid for Step 3, 4, 5 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- STEP 3: Upload Model (Opsional) -->
            <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="step-badge bg-gray-100 text-gray-600">Langkah 3 (Opsional)</span>
                    <h2 class="font-bold text-lg">Wajah Model</h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="relative w-20 h-20 bg-gray-100 rounded-full overflow-hidden flex-shrink-0 border border-gray-200">
                        <img id="modelPreview" class="hidden w-full h-full object-cover">
                        <i data-lucide="user" id="modelPlaceholderIcon" class="text-gray-400 w-8 h-8 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
                    </div>
                    <div class="flex-1">
                        <label class="cursor-pointer bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium inline-block transition-colors">
                            Pilih Foto Wajah
                            <input type="file" id="modelInput" accept="image/*" class="hidden">
                        </label>
                        <p class="text-xs text-gray-500 mt-2">Wajah ini akan dipakai sebagai referensi.</p>
                    </div>
                </div>
            </section>

            <!-- STEP 4 & 5: Tema & Orientasi -->
            <section class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 space-y-6">
                
                <!-- Tema -->
                <div>
                    <div class="flex items-center gap-3 mb-3">
                        <span class="step-badge bg-gray-100 text-gray-600">Langkah 4</span>
                        <h2 class="font-bold text-sm">Tema Foto</h2>
                    </div>
                    <input type="text" id="themeInput" placeholder="Contoh: Minimalis, Outdoor, Estetik Studio..." 
                        class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                </div>

                <!-- Orientasi -->
                <div>
                    <div class="flex items-center gap-3 mb-3">
                        <span class="step-badge">Langkah 5</span>
                        <h2 class="font-bold text-sm">Orientasi</h2>
                    </div>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="orientation" value="16:9" class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm font-medium text-gray-700">Landscape (16:9)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="orientation" value="9:16" checked class="text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm font-medium text-gray-700">Portrait (9:16)</span>
                        </label>
                    </div>
                </div>
            </section>
        </div>

        <!-- STEP 6: Generate Action -->
        <section class="text-center py-4">
            <button id="btnGenerate" class="w-full md:w-auto md:min-w-[300px] bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                <span id="btnGenText" class="flex items-center justify-center gap-2">
                    <i data-lucide="wand-2"></i>
                    Generate Foto Produk
                </span>
                <span id="btnGenLoading" class="hidden flex items-center justify-center gap-2">
                    <div class="loader border-white border-t-transparent"></div>
                    Sedang Memproses (Â±15 detik)...
                </span>
            </button>
            <p id="errorMsg" class="text-red-500 text-sm mt-3 hidden"></p>
        </section>

        <!-- STEP 7: Hasil -->
        <section id="resultSection" class="bg-white rounded-2xl shadow-lg border border-indigo-100 p-6 hidden animate-fade-in">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <span class="step-badge bg-green-100 text-green-700">Selesai</span>
                    <h2 class="font-bold text-lg text-green-800">Hasil Foto Produk</h2>
                </div>
                <button id="btnDownload" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center gap-1">
                    <i data-lucide="download" class="w-4 h-4"></i> Download
                </button>
            </div>

            <div class="bg-gray-900 rounded-xl overflow-hidden flex items-center justify-center relative min-h-[300px] md:min-h-[400px]">
                <img id="finalImage" class="w-full h-auto max-h-[600px] object-contain" alt="Hasil Generate AI">
            </div>
            
            <div class="mt-4 p-4 bg-gray-50 rounded-lg text-xs text-gray-500">
                <p><strong>Prompt yang digunakan:</strong> <span id="usedPrompt" class="italic">...</span></p>
            </div>
        </section>

    </main>

    <footer class="text-center text-gray-400 text-xs py-8">
        &copy; 2025 AI Studio UGC Tool. Powered by Google Gemini.
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // Inisialisasi Icons
        lucide.createIcons();

        // --- STATE MANAGEMENT ---
        const state = {
            apiKey: '', // Akan diisi oleh user
            productImageBase64: null,
            modelImageBase64: null,
            productMimeType: null,
            modelMimeType: null
        };

        // --- DOM ELEMENTS ---
        const els = {
            apiKey: document.getElementById('apiKeyInput'),
            productInput: document.getElementById('productInput'),
            productPreview: document.getElementById('productPreview'),
            productPlaceholder: document.getElementById('productPlaceholder'),
            btnAutoDescribe: document.getElementById('btnAutoDescribe'),
            productDescription: document.getElementById('productDescription'),
            descLoader: document.getElementById('descLoader'),
            modelInput: document.getElementById('modelInput'),
            modelPreview: document.getElementById('modelPreview'),
            modelPlaceholderIcon: document.getElementById('modelPlaceholderIcon'),
            themeInput: document.getElementById('themeInput'),
            radiosOrientation: document.getElementsByName('orientation'),
            btnGenerate: document.getElementById('btnGenerate'),
            btnGenText: document.getElementById('btnGenText'),
            btnGenLoading: document.getElementById('btnGenLoading'),
            errorMsg: document.getElementById('errorMsg'),
            resultSection: document.getElementById('resultSection'),
            finalImage: document.getElementById('finalImage'),
            btnDownload: document.getElementById('btnDownload'),
            usedPrompt: document.getElementById('usedPrompt')
        };

        // --- UTILS ---
        
        // Convert File to Base64
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        // Extract clean Base64 data (remove "data:image/png;base64,")
        const cleanBase64 = (dataUrl) => {
            return dataUrl.split(',')[1];
        };

        // --- EVENT LISTENERS ---

        // Simpan API Key saat diketik
        els.apiKey.addEventListener('input', (e) => {
            state.apiKey = e.target.value.trim();
        });

        // 1. Handle Product Upload
        els.productInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const base64 = await fileToBase64(file);
                state.productImageBase64 = cleanBase64(base64);
                state.productMimeType = file.type;

                // Update UI
                els.productPreview.src = base64;
                els.productPreview.classList.remove('hidden');
                els.productPlaceholder.classList.add('hidden');
            } catch (err) {
                console.error("Error reading file:", err);
                alert("Gagal membaca file gambar.");
            }
        });

        // 2. Handle Model Upload
        els.modelInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const base64 = await fileToBase64(file);
                state.modelImageBase64 = cleanBase64(base64);
                state.modelMimeType = file.type;

                // Update UI
                els.modelPreview.src = base64;
                els.modelPreview.classList.remove('hidden');
                els.modelPlaceholderIcon.classList.add('hidden');
            } catch (err) {
                console.error("Error reading file:", err);
            }
        });

        // 3. Auto Describe (Gemini Vision)
        els.btnAutoDescribe.addEventListener('click', async () => {
            if (!state.apiKey) {
                alert("Mohon masukkan API Key terlebih dahulu.");
                els.apiKey.focus();
                return;
            }
            if (!state.productImageBase64) {
                alert("Mohon upload foto produk terlebih dahulu.");
                return;
            }

            // UI Loading state
            els.btnAutoDescribe.disabled = true;
            els.descLoader.classList.remove('hidden');
            els.productDescription.value = "Sedang menganalisis gambar...";

            try {
                const prompt = "Analisis gambar ini dan berikan deskripsi fisik produk yang sangat detail (warna, material, bentuk, teks pada label) dalam Bahasa Indonesia. Fokus hanya pada objek produknya saja agar cocok untuk prompt image generation.";
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: state.productMimeType, data: state.productImageBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                const description = data.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal menghasilkan deskripsi.";
                els.productDescription.value = description;

            } catch (error) {
                console.error(error);
                els.productDescription.value = "Error: " + error.message;
            } finally {
                els.btnAutoDescribe.disabled = false;
                els.descLoader.classList.add('hidden');
            }
        });

        // 4. Generate Final Image (Gemini Image-to-Image / Multimodal)
        els.btnGenerate.addEventListener('click', async () => {
            if (!state.apiKey) {
                alert("API Key belum diisi!");
                els.apiKey.focus();
                return;
            }
            if (!state.productImageBase64) {
                alert("Foto produk belum diupload!");
                return;
            }
            if (!els.productDescription.value.trim()) {
                alert("Deskripsi produk kosong. Silakan isi atau gunakan fitur Otomatis.");
                return;
            }

            // Reset UI
            els.errorMsg.classList.add('hidden');
            els.resultSection.classList.add('hidden');
            els.btnGenerate.disabled = true;
            els.btnGenText.classList.add('hidden');
            els.btnGenLoading.classList.remove('hidden');

            // Gather Data
            const description = els.productDescription.value;
            const theme = els.themeInput.value || "Studio foto profesional, pencahayaan lembut, bersih";
            const orientation = Array.from(els.radiosOrientation).find(r => r.checked).value;
            const hasModel = !!state.modelImageBase64;

            // Construct Prompt
            // Strategi: Gunakan Image-to-Image (Multimodal) agar produk asli terjaga.
            // Kita kirim gambar produk sebagai input, dan prompt teks untuk memodifikasi latar/konteks.
            let promptText = `Buat foto produk profesional (UGC style) menggunakan gambar produk yang saya lampirkan sebagai referensi utama. Produk: ${description}. Tema/Latar: ${theme}. Rasio aspek foto: ${orientation}. Pastikan produk terlihat jelas, tajam, dan realistis.`;

            if (hasModel) {
                promptText += ` Sertakan seorang model manusia yang berinteraksi dengan produk secara natural. Gunakan gambar wajah yang saya lampirkan sebagai referensi model.`;
            } else {
                promptText += ` Tampilkan produk saja secara estetis tanpa manusia, atau hanya tangan jika relevan dengan tema.`;
            }

            try {
                // Persiapkan Parts Payload
                const parts = [
                    { text: promptText },
                    // Gambar Produk (Wajib)
                    { inlineData: { mimeType: state.productMimeType, data: state.productImageBase64 } }
                ];

                // Jika ada model, tambahkan gambarnya (Multimodal input)
                if (hasModel) {
                    parts.push({ inlineData: { mimeType: state.modelMimeType, data: state.modelImageBase64 } });
                }

                // Call API: Gemini 2.5 Flash Image Preview (Support Image editing/generation from image)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: parts }],
                        generationConfig: {
                            responseModalities: ["IMAGE"] // Meminta output gambar
                        }
                    })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                // Handle Response (Biasanya base64 image di inlineData)
                // Struktur respon Gemini Image Preview bisa berbeda sedikit, biasanya di candidates[0].content.parts[0].inlineData
                const generatedPart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                
                if (!generatedPart) {
                    throw new Error("API tidak mengembalikan gambar. Coba ubah prompt atau gambar input.");
                }

                const finalBase64 = generatedPart.inlineData.data;
                const mimeType = generatedPart.inlineData.mimeType || "image/jpeg";

                // Tampilkan Hasil
                els.finalImage.src = `data:${mimeType};base64,${finalBase64}`;
                els.usedPrompt.textContent = promptText;
                els.resultSection.classList.remove('hidden');
                
                // Scroll ke hasil
                els.resultSection.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error(error);
                els.errorMsg.textContent = "Gagal generate: " + error.message;
                els.errorMsg.classList.remove('hidden');
            } finally {
                els.btnGenerate.disabled = false;
                els.btnGenText.classList.remove('hidden');
                els.btnGenLoading.classList.add('hidden');
            }
        });

        // 5. Download Image
        els.btnDownload.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'ugc-product-generated.jpg';
            link.href = els.finalImage.src;
            link.click();
        });

    </script>
</body>
</html>