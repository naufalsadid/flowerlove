<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Tools Content - Foto Produk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Gray-900 */
            color: #d1d5db; /* Gray-300 */
        }
        /* Custom Aspect Ratios */
        .aspect-9-16 {
            aspect-ratio: 9 / 16;
        }
        .aspect-video {
            aspect-ratio: 16 / 9;
        }

        .card {
            background-color: #1f2937; /* Gray-800 */
            border: 1px solid #374151; /* Gray-700 */
            border-radius: 0.75rem;
        }
        
        /* Button Styles */
        .btn-primary {
            background-color: #06b6d4; /* Cyan-600 */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #0891b2; /* Cyan-700 */
        }
        .btn-primary:disabled {
            background-color: #374151; /* Gray-700 */
            color: #6b7280; /* Gray-500 */
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #374151; /* Gray-700 */
            color: #e5e7eb; /* Gray-200 */
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Gray-600 */
        }
        .btn-secondary:disabled {
            background-color: #1f2937; /* Gray-800 */
            color: #4b5563; /* Gray-600 */
            cursor: not-allowed;
        }

        /* Loading & Effects */
        .loader {
            border: 3px solid rgba(6, 182, 212, 0.5); /* Cyan-600 */
            border-left-color: #374151; /* Gray-700 */
            width: 24px;
            height: 24px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-input-label {
            cursor: pointer;
            border: 2px dashed #4b5563; /* Gray-600 */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .file-input-label:hover {
            border-color: #9ca3af; /* Gray-400 */
            background-color: #374151; /* Gray-700 */
        }
        .result-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Orientation Radio Styles */
        .orientation-label:has(input:checked) {
            border-color: #06b6d4; /* cyan-600 */
            background-color: #0e7490; /* cyan-800 */
        }

        /* Header Animation */
        @keyframes gradient-bg-animate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .header-title-effect {
            background-size: 200% 200%;
            animation: gradient-bg-animate 4s ease infinite;
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #1f2937; /* Gray-800 */
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="text-gray-200 bg-slate-950">

    <div class="relative w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Top Navigation -->
        <div class="absolute top-4 right-4 sm:top-6 sm:right-6 lg:top-8 lg:right-8 z-20 flex gap-3">
             <!-- API Key Button -->
            <button id="api-key-btn" class="flex items-center justify-center w-10 h-10 bg-gray-800 text-yellow-400 font-semibold rounded-full shadow-md hover:bg-gray-700 transition" title="Set API Key">
                <i class="fa-solid fa-key"></i>
            </button>
            
            <!-- Social Media Button -->
            <div class="relative">
                <button id="support-btn" class="flex items-center gap-2 bg-gray-800 text-gray-200 font-semibold py-2 px-4 rounded-full shadow-md hover:bg-gray-700 transition">
                    <i class="fa-solid fa-share-nodes text-lg text-cyan-400"></i>
                    <span class="hidden sm:inline">Social Media</span>
                </button>
                <div id="support-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg border border-gray-700 origin-top-right">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                        <a href="https://www.instagram.com/fikry.sn?igsh=MTJhM2Z1eGtnenRzdg==" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" role="menuitem">Instagram</a>
                        <a href="https://www.tiktok.com/@fikry.sn?_r=1&_t=ZS-91QoyaKqKu8" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" role="menuitem">Tiktok</a>
                        <a href="https://wa.me/62895622493812" target="_blank" rel="noopener noreferrer" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" role="menuitem">WhatsApp</a>
                    </div>
                </div>
            </div>
        </div>

        <header class="text-center mb-10 pt-8 sm:pt-0">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 header-title-effect">
                Magic Tools Content
            </h1>
            <p class="text-lg text-gray-400 mt-2 max-w-3xl mx-auto">
                Solusi untuk Foto Produk dengan Mudah dan Cepat
            </p>
        </header>

        <!-- Main Content: Foto Produk Only -->
        <div id="content-broll" class="tab-content">
            <main class="flex flex-col lg:flex-row gap-8">
                <!-- Input Column -->
                <div class="card p-6 w-full lg:w-1/3 lg:max-w-sm flex-shrink-0 self-start">
                    <div class="flex flex-col gap-6">
                        <div>
                            <h2 class="text-xl font-semibold mb-3 text-gray-100">1. Unggah Gambar Produk</h2>
                            <div id="broll-image-upload-area">
                                <label for="broll-image-input" class="file-input-label rounded-lg text-center text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 2 0 122.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <span>Pilih Gambar Produk</span>
                                    <span class="text-xs mt-1">(Bisa lebih dari satu)</span>
                                </label>
                                <input type="file" id="broll-image-input" class="hidden" accept="image/png, image/jpeg, image/webp" multiple>
                            </div>
                            <div id="broll-image-preview-container" class="hidden mt-4 space-y-3">
                                <div class="grid grid-cols-3 gap-2" id="broll-image-previews">
                                    <!-- Previews will be added here -->
                                </div>
                                <button id="broll-remove-all-product-images-btn" class="w-full btn-secondary text-sm font-semibold py-2 px-3 rounded-lg flex items-center justify-center hover:bg-red-700 hover:text-white transition" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    Hapus Semua Gambar Produk
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-xl font-semibold text-gray-100">2. Deskripsi Produk</h2>
                                <button id="broll-generate-desc-btn" class="btn-secondary text-sm font-semibold py-1 px-3 rounded-md flex items-center" disabled>
                                    âœ¨ Buat Deskripsi
                                </button>
                            </div>
                            <textarea id="broll-product-desc-input" rows="4" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-gray-200 focus:bg-gray-800" placeholder="Contoh: Smartwatch X200 tahan air dengan GPS... atau klik 'Buat Deskripsi' setelah unggah gambar."></textarea>
                        </div>

                        <div>
                            <h2 class="text-xl font-semibold mb-3 text-gray-100">3. Unggah Foto Model <span class="text-sm text-gray-500">(Opsional)</span></h2>
                            <div id="broll-model-image-upload-area">
                                <label for="broll-model-image-input" class="file-input-label rounded-lg text-center text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                    <span>Pilih Foto Model</span>
                                </label>
                                <input type="file" id="broll-model-image-input" class="hidden" accept="image/png, image/jpeg, image/webp">
                            </div>
                            <div id="broll-model-image-preview-container" class="hidden mt-4 relative">
                                <img id="broll-model-image-preview" src="#" alt="Pratinjau Model" class="rounded-lg w-full h-auto object-contain">
                                <button id="broll-remove-model-image-btn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1.5 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"><svg xmlns="http://www.w3.org/2300/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                            </div>
                        </div>

                        <!-- Dropdown Karakter Wajah -->
                        <div>
                            <h2 class="text-xl font-semibold mb-3 text-gray-100">4. Pilih Karakter Wajah <span class="text-sm text-gray-500">(Opsional)</span></h2>
                            <select id="broll-character-select" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-gray-200 focus:bg-gray-800">
                                <option value="">-- Gunakan Model Upload / Default --</option>
                                <option value="Indonesian teenager wearing casual daily outfit, authentic Indonesian look">Remaja Indonesia (Daily Wear)</option>
                                <option value="Young Indonesian woman, natural beauty, casual stylish outfit">Wanita Muda Indonesia (Casual)</option>
                                <option value="Modern Indonesian woman wearing stylish hijab, modest fashion">Wanita Hijab Modern</option>
                                <option value="Young Indonesian man, casual streetwear, friendly expression">Pria Indonesia (Casual)</option>
                                <option value="Professional Indonesian business woman, office attire">Wanita Karir Professional</option>
                                <option value="Professional Indonesian business man, smart casual">Pria Professional (Kantor)</option>
                                <option value="Indonesian university student, trendy and smart look">Mahasiswa Indonesia</option>
                                <option value="Traditional Indonesian beauty, wearing Kebaya or Batik">Wanita Berkebaya/Batik</option>
                                <option value="Cute Indonesian kindergarten kid, playful and happy expression">Anak TK/Balita Indonesia</option>
                                <option value="Indonesian elementary school student (SD) wearing red and white uniform, cheerful">Anak SD Indonesia (Seragam)</option>
                                <option value="Wise Indonesian grandfather, wearing batik or casual shirt, kind smile">Kakek Indonesia (Ramah)</option>
                                <option value="Loving Indonesian grandmother, wearing traditional or modest clothing, warm smile">Nenek Indonesia (Penyayang)</option>
                                <option value="custom">Kustom (Ketik Sendiri)</option>
                            </select>
                            <div id="broll-character-custom-container" class="hidden mt-3">
                                <input type="text" id="broll-character-custom-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-gray-200 focus:bg-gray-800" placeholder="Deskripsikan karakter wajah (contoh: Pria bertato dengan gaya punk)">
                            </div>
                        </div>

                        <div>
                            <h2 class="text-xl font-semibold mb-3 text-gray-100">5. Tema Foto <span class="text-sm text-gray-500">(Opsional)</span></h2>
                            <textarea id="broll-photo-theme-input" rows="3" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition text-gray-200 focus:bg-gray-800" placeholder="Contoh: Minimalis & bersih, nuansa alam tropis, futuristik dengan neon..."></textarea>
                        </div>

                        <div>
                            <h2 class="text-xl font-semibold mb-3 text-gray-100">6. Orientasi Gambar</h2>
                            <div class="flex gap-4">
                                <label for="broll-orientation-horizontal" class="orientation-label flex items-center gap-2 p-3 border border-gray-600 rounded-lg cursor-pointer flex-1 justify-center transition text-gray-300">
                                    <input type="radio" id="broll-orientation-horizontal" name="broll-orientation" value="horizontal" class="hidden" checked>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="12" x="3" y="6" rx="2"></rect></svg>
                                    <span>Horizontal (16:9)</span>
                                </label>
                                <label for="broll-orientation-vertical" class="orientation-label flex items-center gap-2 p-3 border border-gray-600 rounded-lg cursor-pointer flex-1 justify-center transition text-gray-300">
                                    <input type="radio" id="broll-orientation-vertical" name="broll-orientation" value="vertical" class="hidden">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="12" height="18" x="6" y="3" rx="2"></rect></svg>
                                    <span>Vertikal (9:16)</span>
                                </label>
                            </div>
                        </div>

                        <button id="broll-generate-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center text-lg" disabled>
                            <span>Buat 21 Pose Produk</span>
                        </button>
                    </div>
                </div>

                <!-- Output Grid -->
                <div class="flex-grow">
                    <div id="broll-b-roll-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                         <!-- Placeholders loaded by JS -->
                    </div>
                </div>
            </main>
        </div>

        <!-- Universal Modal -->
        <div id="universal-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 id="modal-title" class="text-xl font-bold text-gray-100"></h3><button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button></div><div id="modal-body"></div></div></div>

        <!-- Footer -->
        <footer class="mt-12 py-8 border-t border-gray-700 text-center">
            <p class="text-sm text-gray-400">Developed by Fikry sn</p>
            <div class="flex justify-center items-center gap-6 mt-4">
                <a href="https://www.instagram.com/fikry.sn?igsh=MTJhM2Z1eGtnenRzdg==" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-cyan-500 transition-colors" title="Instagram"><i class="fa-brands fa-instagram text-2xl"></i></a>
                <a href="https://www.tiktok.com/@fikry.sn?_r=1&_t=ZS-91QoyaKqKu8" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-cyan-500 transition-colors" title="Tiktok"><i class="fa-brands fa-tiktok text-2xl"></i></a>
                <a href="https://wa.me/62895622493812" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-cyan-500 transition-colors" title="WhatsApp"><i class="fa-brands fa-whatsapp text-2xl"></i></a>
            </div>
        </footer>
    </div>
    
    <!-- START VANILLA JAVASCRIPT LOGIC -->
    <script>
        const universalModal = document.getElementById('universal-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const apiKeyBtn = document.getElementById('api-key-btn');

        let brollProductImages = [];
        let brollModelImageBase64 = null;
        let brollModelImageMimeType = null;
        
        // Helper to get API Key
        function getApiKey() {
            // Check local storage first
            const storedKey = localStorage.getItem('gemini_api_key');
            // If empty string or null, return empty
            return storedKey || ""; 
        }

        // Helper to save API Key
        function saveApiKey(key) {
            localStorage.setItem('gemini_api_key', key.trim());
            showModal("Sukses", "<p class='text-green-400'>API Key berhasil disimpan! Silakan gunakan tool sekarang.</p>");
        }

        // Show API Key Modal
        function showApiKeyModal() {
            const currentKey = getApiKey();
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-300 text-sm">Untuk menggunakan tool ini di GitHub Pages/hosting sendiri, Anda memerlukan <b>Google Gemini API Key</b> (gratis). Key Anda disimpan di browser (local storage) dan tidak dikirim ke server kami.</p>
                    <div class="flex flex-col gap-2">
                        <label class="text-xs text-gray-400">Masukkan API Key Gemini:</label>
                        <input type="password" id="api-key-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:border-cyan-500 focus:outline-none" value="${currentKey}" placeholder="AIzaVy...">
                        <div class="flex gap-2 text-xs">
                           <input type="checkbox" id="show-api-key" class="mt-1"> <label for="show-api-key" class="text-gray-400 cursor-pointer">Tampilkan Key</label>
                        </div>
                    </div>
                    <button id="save-api-key-btn" class="w-full btn-primary font-bold py-2 px-4 rounded-lg">Simpan Key</button>
                    <div class="text-xs text-center text-gray-500 mt-2">
                        Belum punya key? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-cyan-500 hover:underline">Dapatkan di Google AI Studio</a>
                    </div>
                </div>
            `;
            showModal("ðŸ”‘ Pengaturan API Key", content);
            
            setTimeout(() => {
                const input = document.getElementById('api-key-input');
                const checkbox = document.getElementById('show-api-key');
                const saveBtn = document.getElementById('save-api-key-btn');
                
                if (checkbox && input) {
                    checkbox.addEventListener('change', (e) => {
                        input.type = e.target.checked ? 'text' : 'password';
                    });
                }
                
                if (saveBtn && input) {
                    saveBtn.addEventListener('click', () => {
                        saveApiKey(input.value);
                    });
                }
            }, 100);
        }

        if (apiKeyBtn) {
            apiKeyBtn.addEventListener('click', showApiKeyModal);
        }

        function showModal(title, content) {
            modalTitle.innerText = title;
            modalBody.innerHTML = content;
            universalModal.classList.add('visible');
        }

        async function downloadImage(imageUrl, filename) {
            try {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = imageUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error downloading image:', error);
                showModal('Gagal Mengunduh', `<p class="mb-4">Gagal mengunduh secara otomatis. Silakan <b>tekan dan tahan</b> gambar di bawah ini untuk menyimpannya.</p><img src="${imageUrl}" class="w-full rounded-lg border">`);
            }
        }

        // Global Handlers attached to window for HTML onclick access
        window.downloadCroppedImage = async function(imageUrl, fileName, orientation) {
            try {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = imageUrl;
                await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const targetRatio = orientation === 'horizontal' ? 16 / 9 : 9 / 16;
                const imgRatio = img.width / img.height;
                let sourceX, sourceY, sourceWidth, sourceHeight;
                if (imgRatio > targetRatio) {
                    sourceHeight = img.height; sourceWidth = img.height * targetRatio;
                    sourceX = (img.width - sourceWidth) / 2; sourceY = 0;
                } else {
                    sourceWidth = img.width; sourceHeight = img.width / targetRatio;
                    sourceX = 0; sourceY = (img.height - sourceHeight) / 2;
                }
                canvas.width = sourceWidth; canvas.height = sourceHeight;
                ctx.drawImage(img, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, sourceWidth, sourceHeight);
                const dataUrl = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataUrl; a.download = "Cropped_" + fileName;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } catch (error) {
                console.error("Gagal crop:", error);
                alert('Gagal memotong gambar. Silakan unduh versi asli.');
            }
        };

        window.handleVideoPromptClick = async (imageUrl, title) => {
             const apiKey = getApiKey();
             if (!apiKey) { showApiKeyModal(); return; }

             let mimeType = ''; let base64Data = '';
             try { const parts = imageUrl.split(','); mimeType = parts[0].match(/:(.*?);/)[1]; base64Data = parts[1]; } catch (e) { alert("Gagal memproses data gambar."); return; }
             showModal('Menganalisa Gerakan Video...', `<div class="flex flex-col items-center justify-center p-6"><div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div><p class="text-gray-300 animate-pulse">AI sedang melihat gambar "${title}" untuk menentukan angle gerakan terbaik...</p></div>`);
             try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const prompt = `Analyze this product image composition. Generate a single, simple, and effective text-to-video AI prompt to animate this specific image. Focus ONLY on the most suitable camera movement. Keep it concise (under 20 words). English only. Output ONLY the prompt text.`;
                const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: mimeType, data: base64Data } }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.error) throw new Error(result.error.message);
                const videoPrompt = result.candidates[0].content.parts[0].text.trim();
                const modalContent = `<div class="space-y-4"><p class="text-gray-300">Prompt Gerakan Video (Sesuai Gambar):</p><textarea id="video-prompt-copy-area" class="w-full bg-gray-900 border border-gray-700 p-3 rounded-lg text-cyan-400 font-mono text-sm focus:outline-none focus:border-cyan-500" rows="3" readonly>${videoPrompt}</textarea><div class="flex gap-3"><button id="btn-copy-video-prompt" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition flex items-center justify-center"><i class="fa-solid fa-copy mr-2"></i> Salin Prompt</button></div></div>`;
                showModal('Saran Gerakan Video', modalContent);
                setTimeout(() => { const btn = document.getElementById('btn-copy-video-prompt'); if(btn) { btn.addEventListener('click', () => { const textArea = document.getElementById('video-prompt-copy-area'); textArea.select(); document.execCommand('copy'); btn.innerHTML = `<i class="fa-solid fa-check mr-2"></i> Tersalin!`; setTimeout(() => { btn.innerHTML = `<i class="fa-solid fa-copy mr-2"></i> Salin Prompt`; }, 2000); }); } }, 100);
             } catch (error) { showModal('Gagal', `<p class="text-red-400">Gagal menganalisa gambar. Error: ${error.message}</p>`); }
        };

        window.handleCaptionClick = async (imageUrl, title) => {
            const apiKey = getApiKey();
            if (!apiKey) { showApiKeyModal(); return; }

            const descInput = document.getElementById('broll-product-desc-input');
            const productDescription = descInput && descInput.value.trim() ? descInput.value.trim() : title;
            let mimeType = ''; let base64Data = '';
            try { const parts = imageUrl.split(','); mimeType = parts[0].match(/:(.*?);/)[1]; base64Data = parts[1]; } catch (e) { alert("Gagal memproses data gambar."); return; }
            showModal('Sedang Meracik Caption TikTok...', `<div class="flex flex-col items-center justify-center p-6"><div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div><p class="text-gray-300 animate-pulse">AI sedang menyusun caption singkat & SEO friendly...</p></div>`);
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const prompt = `Bertindaklah sebagai ahli SEO TikTok. Tulis caption TikTok yang SANGAT SINGKAT, PADAT, dan TO THE POINT dalam Bahasa Indonesia.\nSUMBER INFORMASI UTAMA: "${productDescription}"\nPanduan Khusus:\n1. Gaya Bahasa: Santai, to the point. Maksimal 3 kalimat.\n2. SEO: Gunakan kata kunci yang relevan.\n3. Hashtag: TEPAT 5 hashtag relevan, WAJIB HURUF KECIL SEMUA.\nOutput HANYA teks caption lengkap.`;
                const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: mimeType, data: base64Data } }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.error) throw new Error(result.error.message);
                const captionText = result.candidates[0].content.parts[0].text.trim();
                const modalContent = `<div class="space-y-4"><div class="bg-gray-800 p-4 rounded-lg border border-gray-700 max-h-60 overflow-y-auto"><pre id="caption-result-area" class="whitespace-pre-wrap font-sans text-gray-200 text-sm">${captionText}</pre></div><button id="btn-copy-generated-caption" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center"><i class="fa-solid fa-copy mr-2"></i> Salin Caption</button></div>`;
                showModal('âœ¨ Caption TikTok SEO', modalContent);
                setTimeout(() => { const btn = document.getElementById('btn-copy-generated-caption'); if(btn) { btn.addEventListener('click', () => { const text = document.getElementById('caption-result-area').innerText; const temp = document.createElement('textarea'); temp.value = text; document.body.appendChild(temp); temp.select(); document.execCommand('copy'); document.body.removeChild(temp); btn.innerHTML = `<i class="fa-solid fa-check mr-2"></i> Tersalin!`; btn.classList.remove('bg-cyan-600'); btn.classList.add('bg-green-600'); setTimeout(() => { btn.innerHTML = `<i class="fa-solid fa-copy mr-2"></i> Salin Caption`; btn.classList.add('bg-cyan-600'); btn.classList.remove('bg-green-600'); }, 2000); }); } }, 100);
            } catch (error) { showModal('Gagal Membuat Caption', `<p class="text-red-400">Maaf, AI sedang sibuk. ${error.message}</p>`); }
        };

        closeModalBtn.addEventListener('click', () => universalModal.classList.remove('visible'));
        universalModal.addEventListener('click', (e) => { if (e.target === universalModal) universalModal.classList.remove('visible'); });

        // --- Tab 1: AI Product Photography (B-Roll) Logic ---
        (function() {
            const brollImageInput = document.getElementById('broll-image-input');
            const brollImageUploadArea = document.getElementById('broll-image-upload-area');
            const brollImagePreviewContainer = document.getElementById('broll-image-preview-container');
            const brollImagePreviews = document.getElementById('broll-image-previews'); 
            const brollRemoveAllBtn = document.getElementById('broll-remove-all-product-images-btn');
            
            const brollModelImageInput = document.getElementById('broll-model-image-input');
            const brollModelImageUploadArea = document.getElementById('broll-model-image-upload-area');
            const brollModelImagePreviewContainer = document.getElementById('broll-model-image-preview-container');
            const brollModelImagePreview = document.getElementById('broll-model-image-preview');
            const brollRemoveModelImageBtn = document.getElementById('broll-remove-model-image-btn');

            const brollProductDescInput = document.getElementById('broll-product-desc-input');
            const brollGenerateBtn = document.getElementById('broll-generate-btn');
            const brollGrid = document.getElementById('broll-b-roll-grid');
            const brollGenerateDescBtn = document.getElementById('broll-generate-desc-btn');

            const brollCharacterSelect = document.getElementById('broll-character-select');
            const brollCustomCharacterContainer = document.getElementById('broll-character-custom-container');
            
            if(brollCharacterSelect) {
                brollCharacterSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        brollCustomCharacterContainer.classList.remove('hidden');
                    } else {
                        brollCustomCharacterContainer.classList.add('hidden');
                    }
                });
            }

            function updateBrollButtonState() {
                const hasProducts = brollProductImages.length > 0;
                brollGenerateBtn.disabled = !hasProducts || !brollProductDescInput.value.trim();
                brollGenerateDescBtn.disabled = !hasProducts;
                brollRemoveAllBtn.disabled = !hasProducts;
            }
            
            brollImageInput.addEventListener('change', (event) => {
                handleBrollProductFiles(event.target.files);
                event.target.value = null;
            });

            function manageAddMoreButton() {
                const existingButton = document.getElementById('broll-add-more-button');
                if (existingButton) { existingButton.remove(); }
                const addButtonWrapper = document.createElement('div');
                addButtonWrapper.id = 'broll-add-more-button';
                addButtonWrapper.innerHTML = `<label for="broll-image-input" class="w-full h-24 flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-gray-600 cursor-pointer text-gray-400 hover:bg-gray-700 hover:border-cyan-400 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></label>`;
                brollImagePreviews.appendChild(addButtonWrapper);
            }
            
            function handleBrollProductFiles(files) {
                if (files.length === 0) { if (brollProductImages.length > 0) { manageAddMoreButton(); } return; }
                brollImageUploadArea.classList.add('hidden');
                brollImagePreviewContainer.classList.remove('hidden');
                const addButton = document.getElementById('broll-add-more-button');
                if (addButton) addButton.remove();
                let filesToProcess = files.length;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parts = e.target.result.split(',');
                        const mimeType = parts[0].match(/:(.*?);/)[1];
                        const base64 = parts[1];
                        const imageData = { base64, mimeType, id: Date.now() + Math.random() };
                        brollProductImages.push(imageData);
                        const previewWrapper = document.createElement('div');
                        previewWrapper.className = 'relative group';
                        previewWrapper.innerHTML = `<img src="${e.target.result}" alt="Pratinjau Produk" class="rounded-lg w-full h-24 object-cover"><button data-id="${imageData.id}" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100"><svg xmlns="http://www.w3.org/2300/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                        brollImagePreviews.appendChild(previewWrapper); 
                        previewWrapper.querySelector('button').addEventListener('click', (btnEvent) => {
                            const idToRemove = parseFloat(btnEvent.currentTarget.getAttribute('data-id'));
                            brollProductImages = brollProductImages.filter(img => img.id !== idToRemove);
                            previewWrapper.remove();
                            if (brollProductImages.length === 0) {
                                brollImageUploadArea.classList.remove('hidden');
                                brollImagePreviewContainer.classList.add('hidden');
                            } else {
                                manageAddMoreButton();
                            }
                            updateBrollButtonState();
                        });
                        updateBrollButtonState();
                        filesToProcess--;
                        if (filesToProcess === 0) { manageAddMoreButton(); }
                    };
                    reader.readAsDataURL(file);
                });
            }

            brollRemoveAllBtn.addEventListener('click', () => {
                brollProductImages = [];
                brollImagePreviews.innerHTML = ''; 
                brollImageUploadArea.classList.remove('hidden');
                brollImagePreviewContainer.classList.add('hidden');
                brollImageInput.value = null; 
                updateBrollButtonState();
            });

            function setupBrollSingleImageUpload(input, uploadArea, previewContainer, previewImg, removeBtn, onUpload) {
                input.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                            const parts = e.target.result.split(',');
                            const mimeType = parts[0].match(/:(.*?);/)[1];
                            const base64 = parts[1];
                            onUpload(base64, mimeType);
                            uploadArea.classList.add('hidden');
                            previewContainer.classList.remove('hidden');
                            removeBtn.classList.remove('hidden'); 
                        };
                        reader.readAsDataURL(file);
                    } else {
                        onUpload(null, null);
                        input.value = '';
                        uploadArea.classList.remove('hidden');
                        previewContainer.classList.add('hidden');
                        removeBtn.classList.add('hidden'); 
                    }
                });
                removeBtn.addEventListener('click', () => {
                    onUpload(null, null);
                    input.value = '';
                    uploadArea.classList.remove('hidden');
                    previewContainer.classList.add('hidden');
                    removeBtn.classList.add('hidden');
                });
            }
            
            setupBrollSingleImageUpload(brollModelImageInput, brollModelImageUploadArea, brollModelImagePreviewContainer, brollModelImagePreview, brollRemoveModelImageBtn, (base64, mimeType) => {
                brollModelImageBase64 = base64;
                brollModelImageMimeType = mimeType;
            });

            brollProductDescInput.addEventListener('input', updateBrollButtonState);

            const createInitialBrollPlaceholders = () => {
                brollGrid.innerHTML = '';
                const orientation = document.querySelector('input[name="broll-orientation"]:checked')?.value || 'horizontal';
                const aspectRatioClass = orientation === 'vertical' ? 'aspect-9-16' : 'aspect-video'; 
                for(let i = 1; i <= 21; i++) {
                    const card = document.createElement('div');
                    card.className = 'result-card card p-4 flex flex-col justify-between animate-pulse';
                    card.innerHTML = `<div><div class="h-6 bg-gray-600 rounded w-3/4 mb-4"></div></div><div class="mt-4 ${aspectRatioClass} bg-gray-700 rounded-md flex items-center justify-center"></div>`;
                    brollGrid.appendChild(card);
                }
            };
            window.addEventListener('load', createInitialBrollPlaceholders);
            document.querySelectorAll('input[name="broll-orientation"]').forEach(radio => {
                radio.addEventListener('change', createInitialBrollPlaceholders);
            });
            
            const createBrollDynamicCards = (prompts) => {
                brollGrid.innerHTML = '';
                const orientation = document.querySelector('input[name="broll-orientation"]:checked').value;
                const aspectRatioClass = orientation === 'vertical' ? 'aspect-9-16' : 'aspect-video'; 
                prompts.forEach((p, index) => {
                    const card = document.createElement('div');
                    card.id = `broll-card-${index + 1}`;
                    card.className = 'result-card card p-4 flex flex-col justify-between';
                    card.innerHTML = `<div><h3 class="text-lg font-semibold text-gray-100 mb-4">${p.title}</h3></div> <div class="broll-output-container ${aspectRatioClass} bg-gray-700 rounded-md flex items-center justify-center"><div class="loader"></div></div>`;
                    brollGrid.appendChild(card);
                });
            };
            
            brollGenerateDescBtn.addEventListener('click', async () => {
                const apiKey = getApiKey();
                if (!apiKey) { showApiKeyModal(); return; }

                const originalButtonText = brollGenerateDescBtn.innerHTML;
                brollGenerateDescBtn.innerHTML = `<div class="loader !w-4 !h-4 !border-2"></div>`;
                brollGenerateDescBtn.disabled = true;
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const systemPrompt = `You are a professional copywriter. Analyze the product in the image and write a concise, compelling, and SEO-friendly product description in Indonesian. Highlight its key features and potential benefits for customers. Keep it under 500 characters.`;
                    const userQuery = `Buatkan deskripsi produk untuk gambar ini.`;
                    const parts = [ { text: userQuery }];
                    if (brollProductImages.length > 0) { parts.push({ inlineData: { mimeType: brollProductImages[0].mimeType, data: brollProductImages[0].base64 } }); }
                    const payload = { contents: [{ parts: parts }], systemInstruction: { parts: [{ text: systemPrompt }] } };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`); }
                    const result = await response.json();
                    const description = result.candidates[0].content.parts[0].text;
                    brollProductDescInput.value = description.trim();
                    updateBrollButtonState();
                } catch(error) {
                    console.error("Error generating description:", error);
                    brollProductDescInput.value = "Gagal membuat deskripsi. Pastikan API Key benar.";
                    showModal("Error", "Gagal menghubungi AI. Periksa API Key Anda.");
                } finally {
                    brollGenerateDescBtn.innerHTML = originalButtonText;
                    brollGenerateDescBtn.disabled = false;
                }
            });

            // --- FUNCTION DECLARATIONS (DEFINED ONCE INSIDE IIFE) ---

            // 1. Auto-Crop Engine
            function cleanScreenshotImage(base64Image) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); const data = imageData.data; const width = canvas.width; const height = canvas.height;
                            const isRowDominant = (y) => {
                                if (y < 0 || y >= height) return false;
                                const startIdx = y * width * 4; const r0 = data[startIdx]; const g0 = data[startIdx + 1]; const b0 = data[startIdx + 2];
                                let matchCount = 0; const tolerance = 35; const step = 10;
                                for (let x = 0; x < width; x += step) { const i = (y * width + x) * 4; if (Math.abs(data[i] - r0) < tolerance && Math.abs(data[i+1] - g0) < tolerance && Math.abs(data[i+2] - b0) < tolerance) matchCount++; }
                                return (matchCount / (width / step)) > 0.80;
                            };
                            let topCrop = 0; let bottomCrop = 0;
                            for (let y = 0; y < height * 0.25; y += 2) { if (isRowDominant(y)) topCrop = y; else if (!isRowDominant(y+5)) break; }
                            for (let y = height - 1; y > height * 0.75; y -= 2) { if (isRowDominant(y)) bottomCrop = height - 1 - y; else if (!isRowDominant(y-5)) break; }
                            const safetyX = Math.floor(width * 0.02); const safetyY = Math.floor(height * 0.02);
                            let finalY = topCrop > 0 ? topCrop + 2 : safetyY; let finalH = height - finalY - (bottomCrop > 0 ? bottomCrop + 2 : safetyY);
                            let finalX = safetyX; let finalW = width - (safetyX * 2);
                            if (finalH < 100 || finalW < 100 || finalH < height * 0.4) { resolve(base64Image); return; }
                            const finalCanvas = document.createElement('canvas'); finalCanvas.width = finalW; finalCanvas.height = finalH;
                            const finalCtx = finalCanvas.getContext('2d'); finalCtx.drawImage(img, finalX, finalY, finalW, finalH, 0, 0, finalW, finalH);
                            resolve(finalCanvas.toDataURL('image/jpeg', 0.95).split(',')[1]);
                        } catch (e) { console.error("Crop error", e); resolve(base64Image); }
                    };
                    img.onerror = () => resolve(base64Image); img.src = `data:image/jpeg;base64,${base64Image}`;
                });
            }

            // 2. Generate Single B-Roll
            async function generateSingleBroll(id, title, prompt) {
                const card = document.getElementById(`broll-card-${id}`); if (!card) return;
                const outputContainer = card.querySelector('.broll-output-container');
                const retries = 3; let lastError = null;
                const orientation = document.querySelector('input[name="broll-orientation"]:checked').value;
                let character = document.getElementById('broll-character-select').value; if (character === 'custom') character = document.getElementById('broll-character-custom-input').value.trim();
                let ratioInstruction = orientation === 'horizontal' ? ', wide cinematic shot, 16:9 aspect ratio, HIGHLY ENFORCED aspect ratio 16/9, such as 1024x576' : ', tall portrait shot, 9:16 aspect ratio, HIGHLY ENFORCED aspect ratio 9/16, such as 576x1024';
                
                const hasModelUpload = brollModelImageBase64 !== null;
                let characterInstruction = 'No people, solitary product focus.';
                
                if (character) {
                    characterInstruction = `Character: Featuring ${character}.`;
                } else if (hasModelUpload) {
                    characterInstruction = 'Character: Use the model/person from the provided reference image. Maintain their pose and likeness.';
                }

                const apiKey = getApiKey(); // Use dynamic key

                for (let i = 0; i < retries; i++) {
                    try {
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                        let finalPrompt = `[TASK: COMMERCIAL PRODUCT RE-PHOTOGRAPHY]\nINPUT: The input is a raw reference image of a product.\nACTION: Ignore any UI overlays, black bars, or digital borders if they remain. Treat the object in the center as the ONLY subject.\nGOAL: Create a brand new, high-end commercial photograph of this product in a new environment.\nINSTRUCTIONS:\n1. **ZOOM & FILL**: Zoom in on the product. It must fill 75% of the frame.\n2. **NO BORDERS**: The output must be a full-frame photograph. No black edges.\n3. **NEW SCENE**: Generate a completely new, seamless ${orientation} background fitting the theme.\nVISUALS:\nConcept: ${prompt}\nStyle: 8k resolution, photorealistic, ray-traced lighting, sharp focus.\n${characterInstruction}\n${ratioInstruction}`;
                        const parts = [{ text: finalPrompt }];
                        brollProductImages.forEach(img => { parts.push({ inlineData: { mimeType: "image/jpeg", data: img.base64 } }); });
                        if (brollModelImageBase64) { parts.push({ inlineData: { mimeType: "image/jpeg", data: brollModelImageBase64 } }); }
                        const payload = { contents: [{ parts: parts }], generationConfig: { responseModalities: ['IMAGE'] }, safetySettings: [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" } ] };
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json(); const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        if (base64Data) {
                            const imageUrl = `data:image/png;base64,${base64Data}`; const safeTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                            outputContainer.innerHTML = `<div class="relative w-full h-full group"><img src="${imageUrl}" class="w-full h-full object-cover rounded-md" alt="${title}"><div class="absolute bottom-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300"><button onclick="handleVideoPromptClick('${imageUrl}', '${title}')" class="bg-fuchsia-500 text-white p-2 rounded-full hover:bg-fuchsia-600" title="âœ¨ Buat Prompt Video"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 2h6v4H7V5zm8 8H5v-2h10v2z" clip-rule="evenodd" /></svg></button><button onclick="handleCaptionClick('${imageUrl}', '${title}')" class="bg-rose-500 text-white p-2 rounded-full hover:bg-rose-600" title="âœ¨ Buat Caption"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button onclick="downloadCroppedImage('${imageUrl}', 'MTC_${id}_${safeTitle}.png', '${orientation}')" class="bg-green-600 text-white p-2 rounded-full hover:bg-green-700" title="Crop & Unduh (Sesuai Preview)"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2v14a2 2 0 0 0 2 2h14"/><path d="M18 22V8a2 2 0 0 0-2-2H2"/><path d="M22 2 2 22"/></svg></button><button onclick="downloadImage('${imageUrl}', 'MTC_${id}_${safeTitle}_Full.png')" class="bg-cyan-600 text-white p-2 rounded-full hover:bg-cyan-700" title="Unduh Asli (Full)"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button></div></div>`;
                            return;
                        } else {
                             let reason = "Respon OK tetapi gambar tidak ditemukan.";
                            if (result.promptFeedback && result.promptFeedback.blockReason) { reason = `Diblokir: ${result.promptFeedback.blockReason}`; } 
                            throw new Error(reason);
                        }
                    } catch (error) {
                        lastError = error; if (i < retries - 1) await new Promise(res => setTimeout(res, 1000 * Math.pow(2, i)));
                    }
                }
                if (lastError) outputContainer.innerHTML = `<div class="text-xs text-red-400 p-2 text-center">Gagal: ${lastError.message.substring(0, 50)}</div>`;
            }

            // 3. Analyze Prompts
            async function analyzeAndGetPrompts() {
                const apiKey = getApiKey(); // Use dynamic key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const orientation = document.querySelector('input[name="broll-orientation"]:checked').value;
                let character = document.getElementById('broll-character-select').value; if (character === 'custom') character = document.getElementById('broll-character-custom-input').value.trim();
                const screenshotInstruction = " IMPORTANT: If the input image is a SCREENSHOT (contains phone UI, black bars, battery icons, or text overlays), IGNORE those elements completely. Focus ONLY on the actual product inside. Treat the image as if it were cropped to just the product.";
                let systemPrompt = brollModelImageBase64 || character ? `You are an expert AI photo director. Your task is to analyze product images/description and generate 21 distinct shot ideas for a specified orientation: ${orientation}.${screenshotInstruction} Respond ONLY with a valid JSON array of 21 objects.` : `You are an elite-level creative director specializing in high-end product photography. Your primary goal is to generate 21 sophisticated, modern, and elegant photoshoot concepts that are directly relevant to the product provided.${screenshotInstruction} Respond ONLY with a valid JSON array of 21 objects.`;
                const theme = document.getElementById('broll-photo-theme-input').value.trim();
                let userQuery = `Analyze this product. Product Description: "${brollProductDescInput.value.trim()}". Desired orientation is ${orientation}.`; 
                if (character) userQuery += `\nTarget Model Character: "${character}"`; 
                else if (brollModelImageBase64) userQuery += `\nTarget Model: Use the person in the uploaded model image.`;
                if (theme) userQuery += `\nPhoto Theme: "${theme}"`;
                const parts = [{ text: userQuery }]; brollProductImages.forEach(img => { parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } }); }); if (brollModelImageBase64) { parts.push({ inlineData: { mimeType: brollModelImageMimeType, data: brollModelImageBase64 } }); }
                const payload = { contents: [{ parts: parts }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "title": { "type": "STRING" }, "prompt": { "type": "STRING" } }, required: ["title", "prompt"] } } } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                let rawText = result.candidates[0].content.parts[0].text; rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const startIndex = rawText.indexOf('['); const endIndex = rawText.lastIndexOf(']');
                if (startIndex === -1 || endIndex === -1) throw new Error("Could not find a valid JSON array.");
                return JSON.parse(rawText.substring(startIndex, endIndex + 1));
            }

            // 4. Generate Button Listener
            brollGenerateBtn.addEventListener('click', async () => {
                const apiKey = getApiKey();
                if (!apiKey) { showApiKeyModal(); return; }

                if (brollProductImages.length === 0) return;
                brollGenerateBtn.disabled = true;
                brollGenerateBtn.innerHTML = `<div class="loader"></div><span class="ml-2">Membersihkan Screenshot...</span>`;
                brollGrid.innerHTML = `<div class="col-span-1 sm:col-span-2 xl:col-span-3 text-center py-10"><div class="loader inline-block"></div><p class="mt-4 text-gray-400">Sedang membersihkan gambar dan menganalisis produk...</p></div>`;
                try {
                    const cleanPromises = brollProductImages.map(async (img) => { const cleanBase64 = await cleanScreenshotImage(img.base64); img.base64 = cleanBase64; img.mimeType = "image/jpeg"; });
                    if(brollModelImageBase64) { brollModelImageBase64 = await cleanScreenshotImage(brollModelImageBase64); brollModelImageMimeType = "image/jpeg"; }
                    await Promise.all(cleanPromises);
                    brollGenerateBtn.innerHTML = `<div class="loader"></div><span class="ml-2">Menganalisa...</span>`;
                    const brollIdeas = await analyzeAndGetPrompts();
                    brollGenerateBtn.innerHTML = `<div class="loader"></div><span class="ml-2">Membuat Visual...</span>`;
                    createBrollDynamicCards(brollIdeas);
                    await Promise.allSettled(brollIdeas.map((idea, index) => generateSingleBroll(index + 1, idea.title, idea.prompt)));
                } catch (error) {
                    console.error("Error:", error); brollGrid.innerHTML = `<div class="col-span-1 sm:col-span-2 xl:col-span-3 text-center py-10 text-red-400"><p>Terjadi kesalahan: ${error.message}</p></div>`;
                } finally {
                    brollGenerateBtn.disabled = false; brollGenerateBtn.innerHTML = `<span>Buat 21 Pose Produk</span>`;
                }
            });

        })();

        // --- Social Media Support Button Logic ---
        (function() {
            const supportBtn = document.getElementById('support-btn'); const supportDropdown = document.getElementById('support-dropdown');
            if (supportBtn && supportDropdown) {
                supportBtn.addEventListener('click', (e) => { e.stopPropagation(); supportDropdown.classList.toggle('hidden'); });
                document.addEventListener('click', (e) => { if (!supportBtn.contains(e.target) && !supportDropdown.contains(e.target)) { supportDropdown.classList.add('hidden'); } });
            }
        })();
    </script>
</body>
</html>